@page "/s/{Session}"

@implements IDisposable
@inject ISessionManagementService sessionManagementService
@using ScrumPokerClub.Services.Responses
@using ScrumPokerClub.Services.Requests

<CascadingValue Value="Session">
    <div class="row" id="playareamain">
        <NamePlateList @ref="namePlateList" />
        <div class="justify-content-center col-sm-9">
            <TabControl ShowTabs="false" @ref="tabControl">
                <TabPage Title="Voting" @ref="playTab">
                    <NumberPad />
                    <ModeratorToolbox EnableVotingTools="true" />
                </TabPage>
                <TabPage Title="Results" @ref="resultsTab">
                    <ResultsView @ref="resultsView"/>
                    <ModeratorToolbox EnableResultsTools="true" />
                </TabPage>
            </TabControl>
        </div>
    </div>
</CascadingValue>

@code
{
    [Parameter]
    public string Session { get; set; }

    NamePlateList namePlateList;
    TabControl tabControl;
    TabPage playTab;
    TabPage resultsTab;
    ResultsView resultsView;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await sessionManagementService.EnsureSessionConfiguredAsync(new ConfigureSessionRequest()
        {
            Session = Session,
            Configure = session =>
            {
                session.TransitionToResults += OnTransitionToResults;
                session.TransitionToPlay += OnTransitionToPlay;
                session.PlayerConnected += OnPlayerConnected;
                session.PlayerDisconnected += OnPlayerDisconnected;
                session.VoteUpdated += OnVoteUpdated;
                // todo session.PlayerUpdated += OnPlayerUpdated;
            }
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await sessionManagementService.JoinSessionAsync(new JoinSessionRequest()
            {
                Session = Session
            });
        }
    }

    async void OnTransitionToResults(object sender, TransitionToResultsResponse transitionToResultsResponse)
    {
        await Task.CompletedTask;
        tabControl.ActivatePage(resultsTab);

        await namePlateList.OnTransitionToResults(sender, transitionToResultsResponse);
        await resultsView.OnTransitionToResults(sender, transitionToResultsResponse);
    }

    async void OnTransitionToPlay(object sender, TransitionToPlayResponse transitionToPlayResponse)
    {
        await namePlateList.OnTransitionToPlay(sender, transitionToPlayResponse);

        tabControl.ActivatePage(playTab);
    }

    async void OnPlayerConnected(object sender, PlayerConnectedResponse playerConnectedResponse)
    {
        await namePlateList.OnPlayerConnected(sender, playerConnectedResponse);
    }

    async void OnPlayerDisconnected(object sender, PlayerDisconnectedResponse playerDisconnectedResponse)
    {
        await namePlateList.OnPlayerDisconnected(sender, playerDisconnectedResponse);
    }

    async void OnVoteUpdated(object sender, VoteUpdatedResponse voteUpdatedResponse)
    {
        await namePlateList.OnVoteUpdated(sender, voteUpdatedResponse);
    }

    void IDisposable.Dispose()
    {

        sessionManagementService.EnsureSessionConfiguredAsync(new ConfigureSessionRequest()
        {
            Session = Session,
            Configure = session =>
            {
                session.TransitionToResults -= OnTransitionToResults;
                session.TransitionToPlay -= OnTransitionToPlay;
                session.PlayerConnected -= OnPlayerConnected;
                session.PlayerDisconnected -= OnPlayerDisconnected;
                session.VoteUpdated -= OnVoteUpdated;
                // todo session.PlayerUpdated -= OnPlayerUpdated;
            }
        });
    }
}